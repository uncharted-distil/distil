<template>
  <div>
    <b-button block variant="primary" v-b-modal.upload-modal>
      <i class="fa fa-plus-circle"></i> Import File
    </b-button>

    <!-- Modal Component -->
    <b-modal
      id="upload-modal"
      title="Import local file"
      :ok-disabled="!Boolean(file) || this.importDataName.length <= 0"
      @ok="handleOk()"
      @show="clearForm()"
    >
      <b-form-group
        label="Dataset Name"
        label-for="import-name-input"
        invalid-feedback="Dataset name required"
        :state="importDataNameState"
      >
        <b-form-input
          ref="importnameinput"
          id="import-name-input"
          v-model="importDataName"
          :state="importDataNameState"
          required
        />
      </b-form-group>

      <p>Source File (csv, zip)</p>
      <b-form-file
        ref="fileinput"
        v-model="file"
        :state="Boolean(file)"
        accept=".csv, .zip"
        plain
      />
    </b-modal>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import {
  getters as datasetGetters,
  actions as datasetActions,
} from "../store/dataset/module";
import { actions as requestActions } from "../store/requests/module";
import { filterSummariesByDataset } from "../util/data";
import {
  getBase64,
  removeExtension,
  generateUniqueDatasetName,
} from "../util/uploads";
import _ from "lodash";

export default Vue.extend({
  name: "file-uploader",

  data() {
    return {
      file: null as File,
      importDataName: "",
      importDataNameState: null as Boolean,
    };
  },

  props: {
    target: String as () => string,
    targetType: String as () => string,
  },

  methods: {
    clearForm() {
      const $refs = this.$refs as any;
      if ($refs && $refs.fileinput) $refs.fileinput.reset();
      if ($refs && $refs.importnameinput) $refs.fileinput.reset();
      this.file = null;
      this.importDataName = "";
      this.importDataNameState = null;
    },

    async handleOk() {
      const deconflictedName = generateUniqueDatasetName(this.importDataName);

      // Notify external listeners that the file upload is starting
      this.$emit("uploadstart", {
        file: this.file,
        filename: this.file.name,
        datasetID: deconflictedName,
      });

      try {
        // Upload the file and notify when complete
        const response = await datasetActions.uploadDataFile(this.$store, {
          datasetID: deconflictedName,
          file: this.file,
        });
        this.$emit("uploadfinish", null, response);
      } catch (err) {
        this.$emit("uploadfinish", err, null);
      }
    },
  },

  watch: {
    // Watches for file name changes, setting a dataset import name value if the user
    // hasn't done so.
    file() {
      if (!this.importDataName && this.file?.name) {
        // use the filname without the extension
        this.importDataName = removeExtension(this.file.name);
        this.importDataNameState = true;
      }
    },

    // Watches the import data name so that the valid/invalid state can be updated
    importDataName() {
      // allowed transitions are null -> true, true -> false, false -> true
      if (this.importDataNameState === null && !!this.importDataName) {
        this.importDataNameState = true;
      } else if (this.importDataNameState !== null) {
        this.importDataNameState = !!this.importDataName;
      }
    },
  },
});
</script>
