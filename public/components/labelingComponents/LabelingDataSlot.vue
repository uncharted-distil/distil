<template>
  <div class="flex-1 d-flex flex-column pb-1 pt-2">
    <div class="fake-search-input">
      <filter-badge v-if="activeFilter" active-filter :filter="activeFilter" />
      <filter-badge
        v-for="(filter, index) in filters"
        :key="index"
        :filter="filter"
      />
    </div>
    <div class="d-flex justify-content-between m-1">
      <p class="selection-data-slot-summary">
        <strong class="matching-color">matching</strong> samples of
        {{ numRows }} to model<template v-if="selectionNumRows > 0">
          , {{ selectionNumRows }}
          <strong class="selected-color">selected</strong>
        </template>
      </p>
      <label-header-buttons
        @button-event="onAnnotationClicked"
        @select-all="onSelectAll"
      />
      <view-type-toggle
        v-model="viewTypeModel"
        :variables="variables"
        :available-variables="variables"
      />
    </div>
    <div class="label-data-container">
      <component
        :is="viewComponent"
        ref="dataView"
        :data-fields="dataFields"
        :data-items="dataItems"
        :instance-name="instanceName"
        :summaries="summaries"
        pagination
        includedActive
      />
    </div>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import _ from "lodash";
import ViewTypeToggle from "../ViewTypeToggle.vue";
import { Dictionary } from "../../util/dict";
import LabelGeoPlot from "./LabelGeoplot.vue";
import ImageMosaic from "../ImageMosaic.vue";
import SelectDataTable from "../SelectDataTable.vue";
import {
  Variable,
  VariableSummary,
  TableRow,
  TableColumn,
  RowSelection,
  Highlight,
} from "../../store/dataset/index";
import { getters as datasetGetters } from "../../store/dataset/module";
import { getters as routeGetters } from "../../store/route/module";
import {
  LowShotLabels,
  LOW_SHOT_LABEL_COLUMN_NAME,
  LOW_SHOT_SCORE_COLUMN_NAME,
  getAllDataItems,
} from "../../util/data";
import { createFilterFromHighlight } from "../../util/highlights";
import { Filter, INCLUDE_FILTER } from "../../util/filters";
import LabelHeaderButtons from "./LabelHeaderButtons.vue";
import FilterBadge from "../FilterBadge.vue";
import { getNumIncludedRows } from "../../util/row";

const GEO_VIEW = "geo";
const IMAGE_VIEW = "image";
const TABLE_VIEW = "table";
interface DataView {
  selectAll: () => void;
}
export default Vue.extend({
  name: "labeling-data-slot",
  components: {
    ViewTypeToggle,
    LabelGeoPlot,
    ImageMosaic,
    SelectDataTable,
    LabelHeaderButtons,
    FilterBadge,
  },
  props: {
    variables: Array as () => Variable[],
    summaries: Array as () => VariableSummary[],
    instanceName: { type: String, default: "label" },
  },
  data() {
    return {
      viewTypeModel: TABLE_VIEW,
      eventLabel: "DataChanged",
    };
  },
  computed: {
    activeFilter(): Filter {
      if (!this.highlight || !this.highlight.value) {
        return null;
      }
      return createFilterFromHighlight(this.highlight, INCLUDE_FILTER);
    },
    highlight(): Highlight {
      return routeGetters.getDecodedHighlight(this.$store);
    },
    filters(): Filter[] {
      return routeGetters
        .getDecodedFilters(this.$store)
        .filter((f) => f.type !== "row");
    },
    numRows(): number {
      return datasetGetters.getIncludedTableDataNumRows(this.$store);
    },
    selectionNumRows(): number {
      return getNumIncludedRows(this.rowSelection);
    },
    viewComponent(): string {
      if (this.viewTypeModel === GEO_VIEW) return "LabelGeoPlot";
      if (this.viewTypeModel === IMAGE_VIEW) return "ImageMosaic";
      if (this.viewTypeModel === TABLE_VIEW) return "SelectDataTable";
      console.error(`viewType ${this.viewTypeModel} invalid`);
      return "";
    },
    hasLowShotScores(): boolean {
      const orderBy = routeGetters.getOrderBy(this.$store);
      return !orderBy ? false : orderBy.includes(LOW_SHOT_SCORE_COLUMN_NAME);
    },
    dataItems(): TableRow[] {
      const items = _.cloneDeep(
        this.viewTypeModel === GEO_VIEW
          ? getAllDataItems(true)
          : datasetGetters.getIncludedTableDataItems(this.$store)
      );
      if (this.hasLowShotScores) {
        const confidence = "confidence";
        items?.forEach((d, i) => {
          if (d[LOW_SHOT_LABEL_COLUMN_NAME].value === LowShotLabels.unlabeled) {
            d[confidence] = { value: 1.0 - i / items.length };
          } else {
            d[confidence] = {
              value:
                d[LOW_SHOT_LABEL_COLUMN_NAME].value === LowShotLabels.positive
                  ? 1.0
                  : 0.0,
            };
          }
        });
      }
      return items;
    },
    numItems(): number {
      return this.dataItems?.length;
    },
    dataFields(): Dictionary<TableColumn> {
      return datasetGetters.getIncludedTableDataFields(this.$store);
    },
    dataset(): string {
      return routeGetters.getRouteDataset(this.$store);
    },
    rowSelection(): RowSelection {
      return routeGetters.getDecodedRowSelection(this.$store);
    },
    negative(): string {
      return LowShotLabels.negative;
    },
    positive(): string {
      return LowShotLabels.positive;
    },
    unlabeled(): string {
      return LowShotLabels.unlabeled;
    },
  },
  methods: {
    onAnnotationClicked(label: LowShotLabels) {
      if (!this.rowSelection) {
        return;
      }
      this.$emit(this.eventLabel, label);
    },
    onSelectAll() {
      const dataView = (this.$refs.dataView as unknown) as DataView;
      dataView.selectAll();
    },
  },
});
</script>

<style scoped>
.label-data-container {
  display: flex;
  flex-flow: wrap;
  height: 80%;
  position: relative;
  width: 100%;
  background: #eee;
}
.label-headers {
  margin: 5px;
  display: flex;
  justify-content: space-around;
}
.fake-search-input {
  background-color: var(--gray-300);
  border: 1px solid var(--gray-500);
  border-radius: 0.2rem;
  display: flex;
  flex-wrap: wrap;
  min-height: 2.5rem;
  padding: 3px;
}
.selection-data-slot-summary {
  font-size: 90%;
  margin: auto 5px -3px 0; /* Display against the table */
}
</style>
